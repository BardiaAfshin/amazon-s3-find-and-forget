AWSTemplateFormatVersion: "2010-09-09"
Description: TODO (uksb-TODO)

Parameters:

  ProvisionedDynamoDBReadCapacityUnits:
    Description: The DynamoDB Capacity Units allocated for reading the indexes. When this property or ProvisionedDynamoDBWriteCapacityUnits are set to 0, the billing mode is set to on-demand.
    Type: Number
    Default: 0

  ProvisionedDynamoDBWriteCapacityUnits:
    Description: The DynamoDB Capacity Units allocated for reading the indexes. When this property or ProvisionedDynamoDBReadCapacityUnits are set to 0, the billing mode is set to on-demand.
    Type: Number
    Default: 0

  DynamoDBTablePrefix:
    Description: The prefix usesed to name the DynamoDB tables on creation
    Type: String
    Default: S3FindReplace

Conditions:
  DynamoDBOnDemand: !Or [!Equals [ !Ref ProvisionedDynamoDBReadCapacityUnits, 0 ] , !Equals [ !Ref ProvisionedDynamoDBWriteCapacityUnits, 0 ]]

Resources:

  ConfigurationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${DynamoDBTablePrefix}_Configuration
      AttributeDefinitions: 
        - 
          AttributeName: ConfigurationId
          AttributeType: S
      KeySchema: 
        - 
          AttributeName: ConfigurationId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST

  MatchesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${DynamoDBTablePrefix}_Matches
      AttributeDefinitions: 
        - 
          AttributeName: MatchId
          AttributeType: S
        - 
          AttributeName: ObjectPath
          AttributeType: S
      KeySchema: 
        - 
          AttributeName: MatchId
          KeyType: HASH
        -
          AttributeName: ObjectPath
          KeyType: RANGE
      BillingMode: !If [ DynamoDBOnDemand, PAY_PER_REQUEST, PROVISIONED ]
      ProvisionedThroughput:
        !If
          - DynamoDBOnDemand
          - !Ref AWS::NoValue
          - 
            ReadCapacityUnits : !Ref ProvisionedDynamoDBReadCapacityUnits
            WriteCapacityUnits : !Ref ProvisionedDynamoDBWriteCapacityUnits
        
  ObjectsStateTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${DynamoDBTablePrefix}_ObjectsState
      AttributeDefinitions:
        -
          AttributeName: ObjectPath
          AttributeType: S
      KeySchema: 
        - 
          AttributeName: ObjectPath
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
        